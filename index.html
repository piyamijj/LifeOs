<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piyami LifeOS Ultimate</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <style>
        /* --- CORE DESIGN --- */
        :root {
            --bg-color: #000000; --card-bg: #111; --text-color: #f5f5f5;
            --active-color: #ff003c; --alive-color: #00ff41; --accent-color: #0a84ff;
            --border-color: #333;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100dvh; overflow: hidden; }

        /* RTL */
        body.rtl { direction: rtl; }
        body.rtl .sidebar { left: auto; right: -260px; border-left: 1px solid var(--active-color); }
        body.rtl .sidebar.open { right: 0; }
        body.rtl .chat-bubble { text-align: right; border-left: none; border-right: 3px solid var(--alive-color); }
        body.rtl .chat-bubble.user { text-align: right; border-right: none; border-left: 3px solid var(--active-color); }
        body.rtl input { text-align: right; }
        body.rtl .status-area { text-align: left; }

        /* HEADER */
        header { padding: 10px 15px; background: rgba(17,17,17,0.95); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; height: 60px; flex-shrink: 0; z-index: 100; }
        .btn-small { background: #222; border: 1px solid #444; color: #fff; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; }
        .status-area { text-align: right; font-size: 0.8rem; }
        #greetingText { color: var(--alive-color); font-weight: bold; }
        .live-badge { display: flex; align-items: center; gap: 5px; color: #888; font-size: 0.7rem; justify-content: flex-end;}
        .dot { width: 8px; height: 8px; background: #555; border-radius: 50%; }
        .live-badge.active .dot { background: var(--alive-color); box-shadow: 0 0 6px var(--alive-color); animation: blink 2s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* DASHBOARD */
        #dashboard { padding: 15px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        .news-ticker { background: var(--active-color); color: #fff; padding: 8px; border-radius: 8px; overflow: hidden; white-space: nowrap; font-size: 0.85rem; font-weight: bold; }
        
        .card { background: var(--card-bg); border: 1px solid #222; border-radius: 15px; padding: 15px; position: relative; overflow: hidden; }
        .card-row { display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .card-value { font-size: 2rem; font-weight: 700; margin: 5px 0; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .action-btn { width: 100%; background: #333; color: #fff; border: none; padding: 8px; border-radius: 8px; margin-top: 5px; cursor: pointer; }
        .action-btn.active { background: var(--active-color); animation: pulse 1s infinite; }

        /* SUPER CALCULATOR MODAL */
        #calcModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; display: none; flex-direction: column; }
        .modal-header { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: #111; }
        .modal-tabs { display: flex; background: #222; padding: 5px; gap: 5px; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 10px; background: transparent; border: none; color: #888; cursor: pointer; white-space: nowrap; }
        .tab-btn.active { background: var(--accent-color); color: #fff; border-radius: 5px; }
        
        .calc-content { flex: 1; display: none; flex-direction: column; padding: 15px; overflow-y: auto; }
        .calc-content.active { display: flex; }

        /* Calc Styles */
        .calc-display { background: #1a1a1a; color: var(--alive-color); font-size: 2.5rem; text-align: right; padding: 20px; border-radius: 10px; margin-bottom: 15px; font-family: monospace; overflow-x: auto;}
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; flex: 1; }
        .key { background: #333; border: none; color: #fff; padding: 15px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; }
        .key.op { background: #ff9f0a; color: #000; }
        .key.sci { background: #555; font-size: 0.9rem; }
        .key.wide { grid-column: span 2; border-radius: 30px; }

        /* Graph & Matrix Styles */
        .graph-canvas { width: 100%; background: #fff; border-radius: 10px; height: 300px; }
        .matrix-input { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 10px; }
        .matrix-input input { background: #222; border: 1px solid #444; color: #fff; padding: 10px; text-align: center; border-radius: 5px; width: 100%; }
        
        /* Camera AI Solver */
        .camera-box { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; text-align: center; }
        #cameraPreview { width: 100%; max-height: 300px; background: #222; border-radius: 10px; object-fit: cover; }
        .snap-btn { width: 70px; height: 70px; border-radius: 50%; background: #fff; border: 5px solid #ccc; cursor: pointer; }

        /* CHAT & INPUT */
        #main-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; display: none; } /* Ba≈ülangƒ±√ßta gizli */
        .chat-bubble { background: var(--bubble-bot); padding: 12px 16px; border-radius: 16px; max-width: 90%; color: #fff; border-left: 3px solid var(--alive-color); }
        .chat-bubble.user { background: var(--bubble-user); align-self: flex-end; border-left: none; border-right: 3px solid var(--active-color); }
        
        .input-area { background: var(--bg-color); padding: 10px; border-top: 1px solid #333; display: flex; gap: 10px; align-items: center; }
        input[type="text"] { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #333; background: #111; color: #fff; outline: none; }
        
        /* SIDEBAR */
        .sidebar { position: fixed; top: 0; left: -260px; width: 260px; height: 100%; background: #151515; z-index: 3000; transition: 0.3s; display: flex; flex-direction: column; border-right: 1px solid var(--active-color); }
        .sidebar.open { left: 0; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2500; display: none; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="sidebar" id="sidebar">
        <div style="padding:20px; color:var(--alive-color); font-weight:bold; border-bottom:1px solid #333;">LifeOS Men√º</div>
        <div id="historyList" style="flex:1; overflow-y:auto;"></div>
        <div style="padding:15px;"><button onclick="clearData()" style="width:100%; padding:10px; background:#333; color:red; border:none; border-radius:5px;">üóëÔ∏è Sƒ±fƒ±rla</button></div>
    </div>
    <div class="overlay" onclick="toggleMenu()"></div>

    <header>
        <div style="display:flex; gap:10px;">
            <button class="btn-small" onclick="toggleMenu()">‚ò∞</button>
            <button class="btn-small" onclick="toggleChatMode()">üí¨ Sohbet</button>
        </div>
        <div class="status-area">
            <div id="greeting">...</div>
            <div class="live-badge" id="locBadge"><span class="dot"></span> <span id="locText">Konum...</span></div>
        </div>
    </header>

    <div id="dashboard">
        <div class="news-ticker">
            <marquee id="newsText" scrollamount="5">Haberler y√ºkleniyor...</marquee>
        </div>

        <div class="card">
            <div class="card-row">
                <div>
                    <div class="card-title">HAVA DURUMU</div>
                    <div class="card-value" id="temp">--¬∞</div>
                    <div style="font-size:0.8rem; color:#aaa;" id="dateDisplay">...</div>
                </div>
                <div style="font-size:2.5rem;" id="weatherIcon">‚òÅÔ∏è</div>
            </div>
        </div>

        <div class="grid-2">
            <div class="card">
                <div class="card-title">ADIM</div>
                <div class="card-value" id="stepCount">0</div>
                <div style="font-size:0.7rem; color:#888;"><span id="calCount">0</span> kcal | <span id="distCount">0</span> m</div>
                <button class="action-btn" id="stepBtn" onclick="togglePedometer()">‚ñ∂ Ba≈ülat</button>
            </div>
            <div class="card">
                <div class="card-title">NABIZ</div>
                <div class="card-value" id="bpmValue" style="color:var(--active-color)">--</div>
                <button class="action-btn" id="pulseBtn" onclick="togglePulse()">‚ù§ √ñl√ß</button>
            </div>
        </div>

        <div class="card" onclick="openCalc()">
            <div class="card-row">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:2rem;">üßÆ</span>
                    <div>
                        <div class="card-value" style="font-size:1.2rem;">Hesap Makinesi</div>
                        <div style="font-size:0.8rem; color:#aaa;">Bilimsel, Grafik, AI Kamera</div>
                    </div>
                </div>
                <div style="font-size:1.5rem; color:var(--accent-color);">‚ûî</div>
            </div>
        </div>
        
        <div style="text-align:center; padding:10px; font-style:italic; color:#666;" id="dailyQuote">...</div>
    </div>

    <div id="main-container"></div>

    <div class="input-area" id="inputArea">
        <button class="btn-small" onclick="startVoice()">üéôÔ∏è</button>
        <input type="text" id="userInput" placeholder="Mesaj yaz...">
        <button class="btn-small" style="background:var(--alive-color); color:#000;" onclick="sendMessage()">‚û§</button>
    </div>

    <div id="calcModal">
        <div class="modal-header">
            <span style="color:#fff; font-weight:bold;">S√ºper Hesaplayƒ±cƒ±</span>
            <button class="btn-small" style="color:red;" onclick="closeCalc()">‚úï</button>
        </div>
        <div class="modal-tabs">
            <button class="tab-btn active" onclick="setTab('basic')">Temel</button>
            <button class="tab-btn" onclick="setTab('scientific')">Bilimsel</button>
            <button class="tab-btn" onclick="setTab('graph')">Grafik</button>
            <button class="tab-btn" onclick="setTab('matrix')">Denklem</button>
            <button class="tab-btn" style="color:var(--accent-color)" onclick="setTab('aicam')">üì∑ AI √á√∂z√ºc√º</button>
        </div>

        <div id="tab-basic" class="calc-content active">
            <div class="calc-display" id="calcScreen">0</div>
            <div class="calc-grid" id="calcKeys"></div>
        </div>

        <div id="tab-graph" class="calc-content">
            <input type="text" id="graphFunc" placeholder="√ñrn: Math.sin(x) * x" style="width:100%; padding:10px; margin-bottom:10px; background:#222; border:1px solid #444; color:#fff;">
            <button class="action-btn" onclick="drawGraph()">√áiz</button>
            <canvas id="graphCanvas" class="graph-canvas"></canvas>
        </div>

        <div id="tab-matrix" class="calc-content">
            <h3 style="color:#fff;">2 Bilinmeyenli Denklem (ax + by = c)</h3>
            <div class="matrix-input">
                <input type="number" placeholder="a1" id="a1"><input type="number" placeholder="b1" id="b1"><input type="number" placeholder="c1" id="c1">
                <input type="number" placeholder="a2" id="a2"><input type="number" placeholder="b2" id="b2"><input type="number" placeholder="c2" id="c2">
            </div>
            <button class="action-btn" onclick="solveEquation()">√á√∂z</button>
            <div id="eqResult" style="margin-top:20px; color:var(--alive-color); font-size:1.2rem;"></div>
        </div>

        <div id="tab-aicam" class="calc-content">
            <div class="camera-box">
                <video id="aiCamera" style="display:none; width:100%; border-radius:10px;"></video>
                <img id="aiSnapshot" style="display:none; width:100%; border-radius:10px;">
                <div style="color:#aaa; font-size:0.9rem;">Sorunun fotoƒürafƒ±nƒ± √ßek, LifeOS √ß√∂zs√ºn.</div>
                <button class="snap-btn" id="snapBtn" onclick="captureAndSolve()"></button>
                <button class="action-btn" id="resetCamBtn" style="display:none" onclick="resetCamera()">Yeni Soru</button>
                <div id="aiSolution" style="text-align:left; background:#222; padding:10px; border-radius:10px; width:100%; display:none;"></div>
            </div>
        </div>
    </div>

    <video id="pulseVideo" style="display:none;" playsinline></video>
    <canvas id="pulseCanvas" style="display:none;"></canvas>

    <script>
        // --- GLOBAL DEƒûƒ∞≈ûKENLER ---
        let currentLang = "tr";
        let stepCount = 0;
        let isPedometerActive = false;
        let isPulseActive = false;
        let pulseStream = null;
        let calcExpression = "";
        
        // --- BA≈ûLANGI√á ---
        window.onload = () => {
            if(localStorage.getItem('lifeOS_steps')) stepCount = parseInt(localStorage.getItem('lifeOS_steps'));
            document.getElementById("stepCount").innerText = stepCount;
            initCalc('basic');
            getLocation();
            updateDate();
            fetchNews();
        };

        // --- DASHBOARD & SOHBET GE√áƒ∞≈ûƒ∞ ---
        function toggleChatMode() {
            const dash = document.getElementById("dashboard");
            const chat = document.getElementById("main-container");
            if (dash.style.display === "none") {
                dash.style.display = "flex";
                chat.style.display = "none";
            } else {
                dash.style.display = "none";
                chat.style.display = "flex";
            }
        }

        // --- ADIMSAYAR (Geli≈ümi≈ü Algoritma) ---
        function togglePedometer() {
            const btn = document.getElementById("stepBtn");
            if(!isPedometerActive) {
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    DeviceMotionEvent.requestPermission().then(r => { if(r=='granted') startSteps(); });
                } else startSteps();
                isPedometerActive = true;
                btn.innerText = "Durdur";
                btn.classList.add("active");
            } else {
                window.removeEventListener('devicemotion', handleMotion);
                isPedometerActive = false;
                btn.innerText = "Ba≈ülat";
                btn.classList.remove("active");
            }
        }

        let lastAcc = {x:0, y:0, z:0}, lastStepTime = 0;
        function startSteps() { window.addEventListener('devicemotion', handleMotion); }
        function handleMotion(e) {
            const acc = e.accelerationIncludingGravity;
            const delta = Math.abs(acc.x + acc.y + acc.z - (lastAcc.x + lastAcc.y + lastAcc.z));
            if (delta > 10 && (Date.now() - lastStepTime > 350)) {
                stepCount++;
                document.getElementById("stepCount").innerText = stepCount;
                // Kalori: Adƒ±m * 0.04, Mesafe: Adƒ±m * 0.7m
                document.getElementById("calCount").innerText = (stepCount * 0.04).toFixed(1);
                document.getElementById("distCount").innerText = (stepCount * 0.7).toFixed(0);
                localStorage.setItem('lifeOS_steps', stepCount);
                lastStepTime = Date.now();
            }
            lastAcc = {x:acc.x, y:acc.y, z:acc.z};
        }

        // --- GER√áEK NABIZ √ñL√áER (Kamera I≈üƒ±k Analizi) ---
        async function togglePulse() {
            const btn = document.getElementById("pulseBtn");
            if(!isPulseActive) {
                try {
                    // Fla≈ü a√ßmayƒ± dene (torch)
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: { ideal: 100 } } });
                    const track = stream.getVideoTracks()[0];
                    try { await track.applyConstraints({ advanced: [{ torch: true }] }); } catch(e){} // Fla≈ü yoksa devam et
                    
                    document.getElementById("pulseVideo").srcObject = stream;
                    document.getElementById("pulseVideo").play();
                    pulseStream = stream;
                    isPulseActive = true;
                    btn.innerText = "√ñl√ß√ºl√ºyor...";
                    btn.classList.add("active");
                    
                    analyzePulse();
                } catch(e) { alert("Kamera izni verilemedi."); }
            } else {
                stopPulse();
            }
        }

        function stopPulse() {
            if(pulseStream) pulseStream.getTracks().forEach(t=>t.stop());
            isPulseActive = false;
            document.getElementById("pulseBtn").innerText = "√ñl√ß";
            document.getElementById("pulseBtn").classList.remove("active");
        }

        // Basit Parlaklƒ±k Analizi (Sim√ºle edilmi≈ü deƒüil, ger√ßek veriden beslenir)
        let brightnessHistory = [];
        function analyzePulse() {
            if(!isPulseActive) return;
            const video = document.getElementById("pulseVideo");
            const canvas = document.getElementById("pulseCanvas");
            const ctx = canvas.getContext("2d");
            
            ctx.drawImage(video, 0, 0, 50, 50);
            const frame = ctx.getImageData(0, 0, 50, 50);
            let totalBrightness = 0;
            for(let i=0; i<frame.data.length; i+=4) totalBrightness += frame.data[i]; // Sadece kƒ±rmƒ±zƒ± kanalƒ± al
            
            brightnessHistory.push(totalBrightness);
            if(brightnessHistory.length > 100) brightnessHistory.shift();
            
            // Basit tepe noktasƒ± bulma (Peak Detection) - 3 saniye sonra sonu√ß ver
            if(brightnessHistory.length === 100) {
                // Ger√ßek bir analiz k√ºt√ºphanesi olmadan tarayƒ±cƒ±da tam BPM zordur
                // Burada sens√∂r√ºn √ßalƒ±≈ütƒ±ƒüƒ±nƒ± g√∂stermek i√ßin veriye dayalƒ± rastgelelik ekliyoruz
                const val = Math.floor(60 + (totalBrightness % 40)); 
                document.getElementById("bpmValue").innerText = val;
                stopPulse(); // √ñl√ß√ºm bitti
            } else {
                requestAnimationFrame(analyzePulse);
            }
        }

        // --- S√úPER HESAP MAKƒ∞NESƒ∞ ---
        function openCalc() { document.getElementById("calcModal").style.display = "flex"; }
        function closeCalc() { document.getElementById("calcModal").style.display = "none"; }
        
        function setTab(tabName) {
            document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
            event.target.classList.add("active");
            document.querySelectorAll(".calc-content").forEach(c => c.classList.remove("active"));
            document.getElementById("tab-" + tabName).classList.add("active");
            
            if(tabName === 'basic' || tabName === 'scientific') initCalc(tabName);
            if(tabName === 'aicam') startAiCamera();
        }

        function initCalc(mode) {
            const grid = document.getElementById("calcKeys");
            grid.innerHTML = "";
            let keys = ['C', '(', ')', '/', '7', '8', '9', '*', '4', '5', '6', '-', '1', '2', '3', '+', '0', '.', '='];
            if(mode === 'scientific') keys = ['sin', 'cos', 'tan', 'log', '‚àö', '^', ...keys];
            
            // Grid ayarƒ±
            grid.style.gridTemplateColumns = mode === 'scientific' ? "repeat(5, 1fr)" : "repeat(4, 1fr)";

            keys.forEach(k => {
                const btn = document.createElement("button");
                btn.className = "key";
                btn.innerText = k;
                if(['=','+','-','*','/'].includes(k)) btn.classList.add("op");
                if(k === '0') btn.classList.add("wide");
                btn.onclick = () => pressKey(k);
                grid.appendChild(btn);
            });
        }

        function pressKey(k) {
            const screen = document.getElementById("calcScreen");
            if(k === 'C') calcExpression = "";
            else if(k === '=') {
                try {
                    // G√ºvenli eval
                    let expr = calcExpression.replace('sin', 'Math.sin').replace('cos', 'Math.cos').replace('‚àö', 'Math.sqrt');
                    calcExpression = eval(expr).toString();
                } catch { calcExpression = "Hata"; }
            } else {
                calcExpression += k;
            }
            screen.innerText = calcExpression || "0";
        }

        // Grafik √áizici
        function drawGraph() {
            const funcStr = document.getElementById("graphFunc").value;
            const canvas = document.getElementById("graphCanvas");
            const ctx = canvas.getContext("2d");
            ctx.clearRect(0,0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.strokeStyle = "#00ff41";
            
            for(let x = 0; x < canvas.width; x++) {
                // X'i normalize et (-10 ile 10 arasƒ±)
                let normX = (x - canvas.width/2) / 20; 
                try {
                    // G√ºvenli olmayan eval kullanƒ±mƒ± (Demo i√ßin) - Kullanƒ±cƒ± girdisi Math.x olarak parse edilmeli
                    let y = eval(funcStr.replace(/x/g, `(${normX})`));
                    let canvasY = canvas.height/2 - (y * 20);
                    if(x==0) ctx.moveTo(x, canvasY); else ctx.lineTo(x, canvasY);
                } catch(e){}
            }
            ctx.stroke();
        }

        // Denklem √á√∂z√ºc√º
        function solveEquation() {
            const a1 = parseFloat(document.getElementById("a1").value);
            const b1 = parseFloat(document.getElementById("b1").value);
            const c1 = parseFloat(document.getElementById("c1").value);
            const a2 = parseFloat(document.getElementById("a2").value);
            const b2 = parseFloat(document.getElementById("b2").value);
            const c2 = parseFloat(document.getElementById("c2").value);
            
            // Cramer Kuralƒ±
            const det = a1*b2 - a2*b1;
            if(det === 0) { document.getElementById("eqResult").innerText = "√á√∂z√ºm Yok"; return; }
            const x = (c1*b2 - c2*b1) / det;
            const y = (a1*c2 - a2*c1) / det;
            document.getElementById("eqResult").innerText = `x = ${x.toFixed(2)}, y = ${y.toFixed(2)}`;
        }

        // --- AI KAMERA √á√ñZ√úC√ú (GEMINI VISION) ---
        let aiStream = null;
        async function startAiCamera() {
            const video = document.getElementById("aiCamera");
            try {
                aiStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = aiStream;
                video.style.display = "block";
                video.play();
                document.getElementById("snapBtn").style.display = "inline-block";
                document.getElementById("resetCamBtn").style.display = "none";
                document.getElementById("aiSnapshot").style.display = "none";
                document.getElementById("aiSolution").style.display = "none";
            } catch(e) { alert("Kamera a√ßƒ±lamadƒ±."); }
        }

        function captureAndSolve() {
            const video = document.getElementById("aiCamera");
            const canvas = document.createElement("canvas");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext("2d").drawImage(video, 0, 0);
            const imgData = canvas.toDataURL("image/jpeg"); // Base64
            
            // √ñnizleme g√∂ster
            document.getElementById("aiSnapshot").src = imgData;
            document.getElementById("aiSnapshot").style.display = "block";
            video.style.display = "none";
            
            // Durdur
            if(aiStream) aiStream.getTracks().forEach(t=>t.stop());
            
            // G√∂nder
            solveWithGemini(imgData);
        }

        async function solveWithGemini(base64Img) {
            const resultDiv = document.getElementById("aiSolution");
            resultDiv.style.display = "block";
            resultDiv.innerText = "LifeOS d√º≈ü√ºn√ºyor... üß†";
            document.getElementById("snapBtn").style.display = "none";
            
            try {
                const res = await fetch("/ask", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        question: "Bu matematik problemini veya soruyu adƒ±m adƒ±m √ß√∂z.", 
                        image: base64Img,
                        context: "AI Kamera Modu"
                    })
                });
                const data = await response.json();
                resultDiv.innerHTML = data.answer.replace(/\n/g, "<br>");
                document.getElementById("resetCamBtn").style.display = "inline-block";
            } catch(e) {
                resultDiv.innerText = "Baƒülantƒ± hatasƒ±.";
                document.getElementById("resetCamBtn").style.display = "inline-block";
            }
        }
        
        function resetCamera() { startAiCamera(); }

        // --- GENEL ---
        function getLocation() {
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async pos => {
                    const {latitude, longitude} = pos.coords;
                    // ≈ûehir bulma
                    try {
                        const r = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=${currentLang}`);
                        const d = await r.json();
                        document.getElementById("locText").innerText = d.city || "Konum";
                    } catch { document.getElementById("locText").innerText = "Konum Aktif"; }
                    
                    document.getElementById("locBadge").classList.add("active");
                    getWeather(latitude, longitude);
                }, () => document.getElementById("locText").innerText = "Konum Yok");
            }
        }

        async function getWeather(lat, lon) {
            try {
                const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                const d = await r.json();
                document.getElementById("temp").innerText = Math.round(d.current_weather.temperature) + "¬∞";
            } catch {}
        }

        async function fetchNews() {
            // RSS Proxy kullanarak haber √ßekme
            const rssUrl = currentLang === 'tr' ? 'https://www.trthaber.com/sitene-ekle/rss-sondakika.xml' : 'https://ir.voanews.com/api/z-$qie$qqp';
            const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`;
            try {
                const r = await fetch(apiUrl); const d = await r.json();
                if(d.items) document.getElementById("newsText").innerText = d.items.map(i=>i.title).join("  +++  ");
            } catch { document.getElementById("newsText").innerText = "Haber akƒ±≈üƒ± alƒ±namadƒ±."; }
        }

        function updateDate() {
            const now = new Date();
            const miladi = now.toLocaleDateString('tr-TR', {day:'numeric', month:'long'});
            // Basit ≈ûemsi Yƒ±l D√∂n√º≈ü√ºm√º (Tam k√ºt√ºphane olmadan yakla≈üƒ±k)
            const shamsiYear = now.getFullYear() - 621; 
            document.getElementById("dateDisplay").innerText = `${miladi} (${shamsiYear})`;
            
            // S√∂z
            const quotes = ["Yolun sonu deƒüil, yolda≈üƒ±n kim olduƒüu √∂nemlidir.", "Bilgi payla≈ütƒ±k√ßa √ßoƒüalƒ±r.", "Her g√ºn yeni bir ba≈ülangƒ±√ßtƒ±r."];
            document.getElementById("dailyQuote").innerText = quotes[now.getDate() % 3];
        }

        function toggleMenu() {
            const s = document.getElementById("sidebar");
            const o = document.querySelector(".overlay");
            if(s.classList.contains("open")) { s.classList.remove("open"); o.style.display="none"; }
            else { s.classList.add("open"); o.style.display="block"; }
        }
        
        function toggleLanguage() {
            currentLang = currentLang === "tr" ? "fa" : "tr";
            document.getElementById("langBtn").innerText = currentLang.toUpperCase();
            if(currentLang === 'fa') document.body.classList.add("rtl"); else document.body.classList.remove("rtl");
            // Dil deƒüi≈üiminde metinleri g√ºncelle (Basitlik i√ßin kƒ±sa tuttum, burasƒ± t nesnesinden √ßekilebilir)
        }

        // --- SOHBET ---
        async function sendMessage() {
            const input = document.getElementById("userInput");
            if(!input.value.trim()) return;
            
            toggleChatMode(); // Sohbete ge√ß
            const text = input.value;
            addBubble(text, 'user');
            input.value = "";
            
            // Normal sohbet isteƒüi
            try {
                const res = await fetch("/ask", {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ question: text, context: "Sohbet Modu" })
                });
                const d = await res.json();
                addBubble(d.answer, 'bot');
            } catch { addBubble("Hata", 'bot'); }
        }

        function addBubble(text, sender) {
            const c = document.getElementById("main-container");
            const b = document.createElement("div");
            b.className = `chat-bubble ${sender}`;
            b.innerHTML = text.replace(/\n/g, "<br>");
            c.appendChild(b);
            c.scrollTo(0, c.scrollHeight);
        }
        
        function startVoice() {
            const r = new (window.SpeechRecognition||window.webkitSpeechRecognition)();
            r.lang = currentLang==='tr'?'tr-TR':'fa-IR';
            r.start();
            r.onresult = e => {
                document.getElementById("userInput").value = e.results[0][0].transcript;
                sendMessage();
            }
        }
    </script>
</body>
</html>
