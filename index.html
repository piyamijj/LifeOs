<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piyami LifeOS Ultimate</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- CORE DESIGN --- */
        :root {
            --bg-color: #000000; --card-bg: #111; --text-color: #f5f5f5;
            --active-color: #ff003c; --alive-color: #00ff41; --accent-color: #0a84ff;
            --border-color: #333;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100dvh; overflow: hidden; }

        /* RTL (FarsÃ§a Modu Ä°Ã§in) */
        body.rtl { direction: rtl; }
        body.rtl .sidebar { left: auto; right: -260px; border-left: 1px solid var(--active-color); border-right: none; }
        body.rtl .sidebar.open { right: 0; }
        body.rtl .chat-bubble { text-align: right; border-left: none; border-right: 3px solid var(--alive-color); }
        body.rtl .chat-bubble.user { text-align: right; border-right: none; border-left: 3px solid var(--active-color); }
        body.rtl input { text-align: right; }
        body.rtl .status-area { text-align: left; }

        /* HEADER */
        header { padding: 10px 15px; background: rgba(17,17,17,0.95); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; height: 60px; flex-shrink: 0; z-index: 100; }
        .btn-small { background: #222; border: 1px solid #444; color: #fff; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; }
        .status-area { text-align: right; font-size: 0.8rem; }
        #greetingText { color: var(--alive-color); font-weight: bold; }
        .live-badge { display: flex; align-items: center; gap: 5px; color: #888; font-size: 0.7rem; justify-content: flex-end;}
        .dot { width: 8px; height: 8px; background: #555; border-radius: 50%; }
        .live-badge.active .dot { background: var(--alive-color); box-shadow: 0 0 6px var(--alive-color); animation: blink 2s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* DASHBOARD */
        #dashboard { padding: 15px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        .news-ticker { background: var(--active-color); color: #fff; padding: 8px; border-radius: 8px; overflow: hidden; white-space: nowrap; font-size: 0.85rem; font-weight: bold; }
        
        .card { background: var(--card-bg); border: 1px solid #222; border-radius: 15px; padding: 15px; position: relative; overflow: hidden; transition: 0.2s; }
        .card:active { transform: scale(0.98); border-color: var(--alive-color); }
        .card-row { display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .card-value { font-size: 2rem; font-weight: 700; margin: 5px 0; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .action-btn { width: 100%; background: #333; color: #fff; border: none; padding: 8px; border-radius: 8px; margin-top: 5px; cursor: pointer; }
        .action-btn.active { background: var(--active-color); animation: pulse 1s infinite; }

        /* SIDEBAR (MENÃœ) */
        .sidebar { position: fixed; top: 0; left: -260px; width: 260px; height: 100%; background: #151515; z-index: 3000; transition: 0.3s; display: flex; flex-direction: column; border-right: 1px solid var(--active-color); }
        .sidebar.open { left: 0; }
        .menu-header { padding: 20px; color: var(--alive-color); font-weight: bold; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        .menu-section { padding: 15px; border-bottom: 1px solid #222; }
        .menu-label { color: #666; font-size: 0.75rem; margin-bottom: 10px; text-transform: uppercase; }
        .menu-item { display: block; padding: 10px; color: #eee; text-decoration: none; border-radius: 5px; cursor: pointer; margin-bottom: 5px; background: #1a1a1a; }
        .menu-item:hover { background: #222; color: var(--alive-color); }
        .menu-item span { margin-right: 10px; }
        body.rtl .menu-item span { margin-right: 0; margin-left: 10px; }

        /* MODAL & CALC */
        #calcModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; display: none; flex-direction: column; }
        .modal-header { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: #111; }
        .modal-tabs { display: flex; background: #222; padding: 5px; gap: 5px; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 10px; background: transparent; border: none; color: #888; cursor: pointer; white-space: nowrap; font-size: 0.8rem; }
        .tab-btn.active { background: var(--accent-color); color: #fff; border-radius: 5px; }
        .calc-content { flex: 1; display: none; flex-direction: column; padding: 15px; overflow-y: auto; }
        .calc-content.active { display: flex; }
        .calc-display { background: #1a1a1a; color: var(--alive-color); font-size: 2rem; text-align: right; padding: 15px 20px; border-radius: 10px; margin-bottom: 15px; font-family: monospace; }
        .calc-grid { display: grid; gap: 8px; }
        .key { background: #333; border: none; color: #fff; padding: 18px; border-radius: 12px; font-size: 1.1rem; cursor: pointer; }
        .key.op { background: #ff9f0a; color: #000; font-weight: bold; }
        
        /* CHAT */
        #main-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; display: none; }
        .chat-bubble { background: #1a1a1a; padding: 12px 16px; border-radius: 16px; max-width: 90%; color: #fff; border-left: 3px solid var(--alive-color); }
        .chat-bubble.user { background: #222; align-self: flex-end; border-left: none; border-right: 3px solid var(--active-color); }
        .input-area { background: var(--bg-color); padding: 10px; border-top: 1px solid #333; display: flex; gap: 10px; align-items: center; }
        input[type="text"] { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #333; background: #111; color: #fff; outline: none; }
        
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2500; display: none; }
    </style>
</head>
<body>

    <div class="sidebar" id="sidebar">
        <div class="menu-header">
            <span id="menuTitle">LifeOS MenÃ¼</span>
            <span onclick="toggleMenu()" style="cursor:pointer">âœ•</span>
        </div>
        
        <div class="menu-section">
            <div class="menu-label" id="lblLessons">Dersler & EÄŸitim</div>
            <div class="menu-item" onclick="startLesson('Almanca')"><span>ğŸ‡©ğŸ‡ª</span> <span id="btnDE">Almanca Ã–ÄŸren</span></div>
            <div class="menu-item" onclick="startLesson('Ä°ngilizce')"><span>ğŸ‡¬ğŸ‡§</span> <span id="btnEN">Ä°ngilizce Ã–ÄŸren</span></div>
            <div class="menu-item" onclick="startLesson('FarsÃ§a')"><span>ğŸ‡®ğŸ‡·</span> <span id="btnFA">FarsÃ§a Ã–ÄŸren</span></div>
        </div>

        <div class="menu-section">
            <div class="menu-label" id="lblTools">AraÃ§lar</div>
            <div class="menu-item" onclick="toggleMenu(); openCalc()"><span>ğŸ§®</span> <span id="btnCalc">Hesap Makinesi</span></div>
            <div class="menu-item" onclick="toggleMenu(); togglePedometer()"><span>ğŸ‘Ÿ</span> <span id="btnStep">AdÄ±msayar</span></div>
        </div>

        <div id="historyList" style="flex:1; overflow-y:auto; padding:15px;"></div>
        <div style="padding:15px;"><button onclick="clearData()" style="width:100%; padding:10px; background:#333; color:red; border:none; border-radius:5px;">ğŸ—‘ï¸ Reset</button></div>
    </div>
    <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

    <header>
        <div style="display:flex; gap:10px;">
            <button class="btn-small" onclick="toggleMenu()">â˜°</button>
            <button class="btn-small" id="chatBtn" onclick="toggleChatMode()">ğŸ’¬ Sohbet</button>
            <button class="btn-small" onclick="toggleLang()">TR / FA</button>
        </div>
        <div class="status-area">
            <div id="greeting" style="color:var(--alive-color); font-weight:bold;">...</div>
            <div class="live-badge" id="locBadge"><span class="dot"></span> <span id="locText">Konum...</span></div>
        </div>
    </header>

    <div id="dashboard">
        <div class="news-ticker">
            <marquee id="newsText" scrollamount="5">Haberler yÃ¼kleniyor...</marquee>
        </div>

        <div class="card">
            <div class="card-row">
                <div>
                    <div class="card-title" id="lblWeather">HAVA DURUMU</div>
                    <div class="card-value" id="temp">--Â°</div>
                    <div style="font-size:0.8rem; color:#aaa;" id="dateDisplay">...</div>
                </div>
                <div style="font-size:2.5rem;" id="weatherIcon">â˜ï¸</div>
            </div>
        </div>

        <div class="grid-2">
            <div class="card">
                <div class="card-title" id="lblStep">ADIM</div>
                <div class="card-value" id="stepCount">0</div>
                <div style="font-size:0.7rem; color:#888;"><span id="calCount">0</span> kcal</div>
                <button class="action-btn" id="stepBtn" onclick="togglePedometer()">â–¶ BaÅŸlat</button>
            </div>
            <div class="card">
                <div class="card-title" id="lblPulse">NABIZ</div>
                <div class="card-value" id="bpmValue" style="color:var(--active-color)">--</div>
                <button class="action-btn" id="pulseBtn" onclick="togglePulse()">â¤ Ã–lÃ§</button>
            </div>
        </div>

        <div class="card" onclick="openCalc()">
            <div class="card-row">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:2rem;">ğŸ§®</span>
                    <div>
                        <div class="card-value" style="font-size:1.2rem;" id="lblCalcTitle">Hesap Makinesi</div>
                        <div style="font-size:0.8rem; color:#aaa;" id="lblCalcDesc">Bilimsel, Grafik, AI Kamera</div>
                    </div>
                </div>
                <div style="font-size:1.5rem; color:var(--accent-color);">â”</div>
            </div>
        </div>
        
        <div style="text-align:center; padding:10px; font-style:italic; color:#666;" id="dailyQuote">...</div>
    </div>

    <div id="main-container"></div>

    <div class="input-area" id="inputArea">
        <button class="btn-small" onclick="startVoice()">ğŸ™ï¸</button>
        <input type="text" id="userInput" placeholder="Mesaj yaz..." onkeypress="if(event.key==='Enter') sendMessage()">
        <button class="btn-small" style="background:var(--alive-color); color:#000;" onclick="sendMessage()">â¤</button>
    </div>

    <div id="calcModal">
        <div class="modal-header">
            <span style="color:#fff; font-weight:bold;">SÃ¼per HesaplayÄ±cÄ±</span>
            <button class="btn-small" style="color:red;" onclick="closeCalc()">âœ•</button>
        </div>
        <div class="modal-tabs">
            <button class="tab-btn active" onclick="setTab('basic')">Temel</button>
            <button class="tab-btn" onclick="setTab('scientific')">Bilimsel</button>
            <button class="tab-btn" onclick="setTab('aicam')">ğŸ“· AI Kamera</button>
        </div>

        <div id="tab-basic" class="calc-content active">
            <div class="calc-display" id="calcScreen">0</div>
            <div class="calc-grid" id="calcKeys" style="grid-template-columns: repeat(4, 1fr);"></div>
        </div>

        <div id="tab-scientific" class="calc-content">
            <div class="calc-display" id="sciScreen">0</div>
            <div class="calc-grid" id="sciKeys" style="grid-template-columns: repeat(5, 1fr);"></div>
        </div>

        <div id="tab-aicam" class="calc-content">
            <div class="camera-box" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
                <video id="aiCamera" style="display:none; width:100%; border-radius:10px;"></video>
                <img id="aiSnapshot" style="display:none; width:100%; border-radius:10px;">
                <div style="color:#aaa; margin:10px;">Sorunun fotoÄŸrafÄ±nÄ± Ã§ek, LifeOS Ã§Ã¶zsÃ¼n.</div>
                <button style="width:70px; height:70px; border-radius:50%; background:#fff; border:5px solid #ccc;" id="snapBtn" onclick="captureAndSolve()"></button>
                <button class="action-btn" id="resetCamBtn" style="display:none" onclick="startAiCamera()">Yeni Soru</button>
                <div id="aiSolution" style="text-align:left; background:#222; padding:10px; border-radius:10px; width:100%; margin-top:10px; display:none;"></div>
            </div>
        </div>
    </div>

    <video id="pulseVideo" style="display:none;" playsinline></video>
    <canvas id="pulseCanvas" style="display:none;" width="50" height="50"></canvas>

    <script>
        // --- AYARLAR ---
        let currentLang = "tr";
        let stepCount = parseInt(localStorage.getItem('lifeOS_steps')) || 0;
        let isPedometerActive = false;
        let isPulseActive = false;
        let pulseStream = null;
        let calcExpression = "";
        let sciExpression = "";

        // --- BAÅLANGIÃ‡ ---
        window.onload = () => {
            document.getElementById("stepCount").innerText = stepCount;
            initCalc('basic');
            initCalc('scientific');
            getLocation();
            updateUI();
            fetchNews();
        };

        // --- DÄ°L VE ARAYÃœZ (GÃœNCELLENDÄ°) ---
        function toggleLang() {
            currentLang = currentLang === 'tr' ? 'fa' : 'tr';
            if (currentLang === 'fa') document.body.classList.add('rtl');
            else document.body.classList.remove('rtl');
            updateUI();
        }

        function updateUI() {
            const tr = currentLang === 'tr';
            
            // Metinler
            document.getElementById('lblWeather').innerText = tr ? 'HAVA DURUMU' : 'Ø¢Ø¨ Ùˆ Ù‡ÙˆØ§';
            document.getElementById('lblStep').innerText = tr ? 'ADIM' : 'Ú¯Ø§Ù…';
            document.getElementById('lblPulse').innerText = tr ? 'NABIZ' : 'Ø¶Ø±Ø¨Ø§Ù† Ù‚Ù„Ø¨';
            document.getElementById('lblCalcTitle').innerText = tr ? 'Hesap Makinesi' : 'Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨';
            document.getElementById('lblCalcDesc').innerText = tr ? 'Bilimsel, AI Kamera' : 'Ø¹Ù„Ù…ÛŒØŒ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù‡ÙˆØ´Ù…Ù†Ø¯';
            
            // Butonlar
            document.getElementById('stepBtn').innerText = isPedometerActive ? (tr?'Durdur':'ØªÙˆÙ‚Ù') : (tr?'BaÅŸlat':'Ø´Ø±ÙˆØ¹');
            document.getElementById('pulseBtn').innerText = isPulseActive ? (tr?'Ã–lÃ§Ã¼lÃ¼yor...':'Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ú¯ÛŒØ±ÛŒ...') : (tr?'Ã–lÃ§':'Ø§Ù†Ø¯Ø§Ø²Ù‡ Ú¯ÛŒØ±ÛŒ');
            document.getElementById('chatBtn').innerText = tr ? 'ğŸ’¬ Sohbet' : 'ğŸ’¬ Ú†Øª';
            
            // MenÃ¼
            document.getElementById('menuTitle').innerText = tr ? 'LifeOS MenÃ¼' : 'Ù…Ù†ÙˆÛŒ LifeOS';
            document.getElementById('lblLessons').innerText = tr ? 'Dersler & EÄŸitim' : 'Ø¯Ø±Ø³ Ù‡Ø§ Ùˆ Ø¢Ù…ÙˆØ²Ø´';
            document.getElementById('lblTools').innerText = tr ? 'AraÃ§lar' : 'Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§';
            document.getElementById('btnDE').innerText = tr ? 'Almanca Ã–ÄŸren' : 'Ø¢Ù…ÙˆØ²Ø´ Ø¢Ù„Ù…Ø§Ù†ÛŒ';
            document.getElementById('btnEN').innerText = tr ? 'Ä°ngilizce Ã–ÄŸren' : 'Ø¢Ù…ÙˆØ²Ø´ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ';
            document.getElementById('btnFA').innerText = tr ? 'FarsÃ§a Ã–ÄŸren' : 'Ø¢Ù…ÙˆØ²Ø´ ÙØ§Ø±Ø³ÛŒ';
            document.getElementById('btnCalc').innerText = tr ? 'Hesap Makinesi' : 'Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨';
            document.getElementById('btnStep').innerText = tr ? 'AdÄ±msayar' : 'Ú¯Ø§Ù… Ø´Ù…Ø§Ø±';

            document.getElementById('userInput').placeholder = tr ? 'Mesaj yaz...' : 'Ù¾ÛŒØ§Ù… Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...';
            
            updateDate(); // Tarihi gÃ¼ncelle
        }

        function updateDate() {
            const now = new Date();
            if (currentLang === 'tr') {
                const trDate = now.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' });
                document.getElementById("dateDisplay").innerText = trDate;
                document.getElementById("greeting").innerText = (now.getHours() < 12 ? "GÃ¼naydÄ±n Piyami" : "Ä°yi AkÅŸamlar Piyami");
                document.getElementById("dailyQuote").innerText = "\"Bilgi paylaÅŸtÄ±kÃ§a Ã§oÄŸalÄ±r.\"";
            } else {
                // Åemsi Takvim (Basit Ã‡eviri)
                const formatter = new Intl.DateTimeFormat('fa-IR-u-ca-persian', { day: 'numeric', month: 'long', year: 'numeric' });
                document.getElementById("dateDisplay").innerText = formatter.format(now);
                document.getElementById("greeting").innerText = (now.getHours() < 12 ? "ØµØ¨Ø­ Ø¨Ø®ÛŒØ± Ù¾ÛŒØ§Ù…ÛŒ" : "Ø¹ØµØ± Ø¨Ø®ÛŒØ± Ù¾ÛŒØ§Ù…ÛŒ");
                document.getElementById("dailyQuote").innerText = "\"Ø¯Ø§Ù†Ø´ Ø¨Ø§ Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø§ÙØ²Ø§ÛŒØ´ Ù…ÛŒâ€ŒÛŒØ§Ø¨Ø¯\"";
            }
        }

        // --- DERS MODU (EKSÄ°K PARÃ‡A GELDÄ°) ---
        function startLesson(lang) {
            toggleMenu();
            toggleChatMode(); // Sohbet ekranÄ±nÄ± aÃ§
            
            const prompt = `Ben ${lang} Ã¶ÄŸrenmek istiyorum. LÃ¼tfen bir Ã¶ÄŸretmen gibi davran ve bana baÅŸlangÄ±Ã§ seviyesinden bir ders planÄ± sun.`;
            addBubble(`ğŸ“š ${lang} Ders Modu BaÅŸlatÄ±ldÄ±...`, 'user');
            
            // Sunucuya istek at (Gizli)
            fetch("/ask", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ question: prompt, context: "EÄŸitim Modu" })
            })
            .then(r => r.json())
            .then(d => addBubble(d.answer, 'bot'))
            .catch(() => addBubble("BaÄŸlantÄ± hatasÄ±.", 'bot'));
        }

        // --- DÄ°ÄER FONKSÄ°YONLAR (Senin kodlar aynen korundu) ---
        function toggleChatMode() {
            const dash = document.getElementById("dashboard");
            const chat = document.getElementById("main-container");
            if (dash.style.display === "none") {
                dash.style.display = "flex"; chat.style.display = "none";
            } else {
                dash.style.display = "none"; chat.style.display = "flex";
            }
        }

        function toggleMenu() {
            const s = document.getElementById("sidebar");
            const o = document.getElementById("overlay");
            if(s.classList.contains("open")) { s.classList.remove("open"); o.style.display="none"; } 
            else { s.classList.add("open"); o.style.display="block"; }
        }

        // --- ADIMSAYAR ---
        function togglePedometer() {
            const btn = document.getElementById("stepBtn");
            if(!isPedometerActive) {
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    DeviceMotionEvent.requestPermission().then(r => { if(r=='granted') startSteps(); });
                } else startSteps();
                isPedometerActive = true;
                btn.innerText = currentLang==='tr'?"Durdur":"ØªÙˆÙ‚Ù";
                btn.classList.add("active");
            } else {
                window.removeEventListener('devicemotion', handleMotion);
                isPedometerActive = false;
                btn.innerText = currentLang==='tr'?"BaÅŸlat":"Ø´Ø±ÙˆØ¹";
                btn.classList.remove("active");
            }
        }
        let lastAcc = {x:0, y:0, z:0}, lastStepTime = 0;
        function startSteps() { window.addEventListener('devicemotion', handleMotion); }
        function handleMotion(e) {
            const acc = e.accelerationIncludingGravity;
            if(!acc) return;
            const delta = Math.abs(acc.x + acc.y + acc.z - (lastAcc.x + lastAcc.y + lastAcc.z));
            if (delta > 10 && (Date.now() - lastStepTime > 350)) {
                stepCount++;
                document.getElementById("stepCount").innerText = stepCount;
                document.getElementById("calCount").innerText = (stepCount * 0.04).toFixed(1);
                localStorage.setItem('lifeOS_steps', stepCount);
                lastStepTime = Date.now();
            }
            lastAcc = {x:acc.x, y:acc.y, z:acc.z};
        }

        // --- NABIZ ---
        async function togglePulse() {
            const btn = document.getElementById("pulseBtn");
            if(!isPulseActive) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: { ideal: 100 } } });
                    const track = stream.getVideoTracks()[0];
                    try { await track.applyConstraints({ advanced: [{ torch: true }] }); } catch(e){}
                    
                    document.getElementById("pulseVideo").srcObject = stream;
                    document.getElementById("pulseVideo").play();
                    pulseStream = stream;
                    isPulseActive = true;
                    btn.innerText = "Wait...";
                    btn.classList.add("active");
                    analyzePulse();
                } catch(e) { alert("Kamera izni gerekli!"); }
            } else { stopPulse(); }
        }
        function stopPulse() {
            if(pulseStream) pulseStream.getTracks().forEach(t=>t.stop());
            isPulseActive = false;
            btn = document.getElementById("pulseBtn");
            btn.innerText = currentLang==='tr'?"Ã–lÃ§":"Ø§Ù†Ø¯Ø§Ø²Ù‡ Ú¯ÛŒØ±ÛŒ";
            btn.classList.remove("active");
        }
        let brightHist = [];
        function analyzePulse() {
            if(!isPulseActive) return;
            const v = document.getElementById("pulseVideo");
            const c = document.getElementById("pulseCanvas");
            const ctx = c.getContext("2d");
            ctx.drawImage(v,0,0,50,50);
            const d = ctx.getImageData(0,0,50,50).data;
            let b = 0; for(let i=0; i<d.length; i+=4) b+=d[i];
            brightHist.push(b); if(brightHist.length>100) brightHist.shift();
            if(brightHist.length===100) {
                document.getElementById("bpmValue").innerText = Math.floor(60 + (b%40));
                stopPulse();
            } else requestAnimationFrame(analyzePulse);
        }

        // --- HESAP MAKÄ°NESÄ° ---
        function openCalc() { document.getElementById("calcModal").style.display = "flex"; }
        function closeCalc() { document.getElementById("calcModal").style.display = "none"; }
        function setTab(t) {
            document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
            event.target.classList.add("active");
            document.querySelectorAll(".calc-content").forEach(c=>c.classList.remove("active"));
            document.getElementById("tab-"+t).classList.add("active");
            if(t==='aicam') startAiCamera();
        }
        function initCalc(mode) {
            const g = mode==='basic'?document.getElementById("calcKeys"):document.getElementById("sciKeys");
            g.innerHTML="";
            const k = mode==='basic'?['C','(',')','/','7','8','9','*','4','5','6','-','1','2','3','+','0','.','=']:
            ['sin','cos','tan','log','âˆš','C','(',')','^','/','7','8','9','*','Ï€','4','5','6','-','e','1','2','3','+','0','.','='];
            k.forEach(x=>{
                const b=document.createElement("button"); b.className="key"; b.innerText=x;
                if(['=','+','-','*','/'].includes(x)) b.classList.add("op");
                if(x==='0' && mode==='basic') b.style.gridColumn="span 2";
                b.onclick=()=>press(x, mode); g.appendChild(b);
            });
        }
        function press(k,m) {
            const s = m==='basic'?document.getElementById("calcScreen"):document.getElementById("sciScreen");
            let e = m==='basic'?calcExpression:sciExpression;
            if(k==='C') e="";
            else if(k==='=') { try{ e=eval(e.replace('^','**').replace('Ï€',Math.PI).replace('e',Math.E)).toString(); }catch{e="Err";} }
            else e+=k;
            if(m==='basic') calcExpression=e; else sciExpression=e;
            s.innerText=e||"0";
        }

        // --- AI KAMERA ---
        let aiStream=null;
        async function startAiCamera() {
            try {
                aiStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
                document.getElementById("aiCamera").srcObject=aiStream;
                document.getElementById("aiCamera").style.display="block";
                document.getElementById("aiCamera").play();
                document.getElementById("snapBtn").style.display="inline-block";
                document.getElementById("aiSnapshot").style.display="none";
                document.getElementById("aiSolution").style.display="none";
                document.getElementById("resetCamBtn").style.display="none";
            } catch(e){ alert("Kamera hatasÄ±"); }
        }
        function captureAndSolve() {
            const v = document.getElementById("aiCamera");
            const c = document.createElement("canvas");
            c.width=v.videoWidth; c.height=v.videoHeight;
            c.getContext("2d").drawImage(v,0,0);
            const img = c.toDataURL("image/jpeg");
            document.getElementById("aiSnapshot").src=img;
            document.getElementById("aiSnapshot").style.display="block";
            v.style.display="none";
            if(aiStream) aiStream.getTracks().forEach(t=>t.stop());
            document.getElementById("snapBtn").style.display="none";
            
            document.getElementById("aiSolution").style.display="block";
            document.getElementById("aiSolution").innerText="LifeOS dÃ¼ÅŸÃ¼nÃ¼yor...";
            
            fetch("/ask", {
                method:"POST", headers:{"Content-Type":"application/json"},
                body:JSON.stringify({question:"Bu problemi Ã§Ã¶z", image:img})
            }).then(r=>r.json()).then(d=>{
                document.getElementById("aiSolution").innerHTML=d.answer.replace(/\n/g,"<br>");
                document.getElementById("resetCamBtn").style.display="inline-block";
            }).catch(()=>{ document.getElementById("aiSolution").innerText="Hata"; });
        }

        // --- SOHBET ---
        async function sendMessage() {
            const inp = document.getElementById("userInput");
            if(!inp.value.trim()) return;
            const txt = inp.value;
            toggleChatMode();
            addBubble(txt, 'user');
            inp.value="";
            
            try {
                const r = await fetch("/ask", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({question:txt})});
                const d = await r.json();
                addBubble(d.answer, 'bot');
            } catch { addBubble("Hata", 'bot'); }
        }
        function addBubble(t,s) {
            const c=document.getElementById("main-container");
            const d=document.createElement("div"); d.className=`chat-bubble ${s}`;
            d.innerHTML=t.replace(/\n/g,"<br>"); c.appendChild(d); c.scrollTo(0,c.scrollHeight);
        }
        function startVoice() {
            const r = new (window.SpeechRecognition||window.webkitSpeechRecognition)();
            r.lang = currentLang==='tr'?'tr-TR':'fa-IR';
            r.start();
            r.onresult = e => { document.getElementById("userInput").value = e.results[0][0].transcript; sendMessage(); }
        }
        function clearData() { if(confirm('Reset?')) { localStorage.clear(); location.reload(); } }
        function getLocation() {
            if(navigator.geolocation) navigator.geolocation.getCurrentPosition(p=>{
                document.getElementById("locText").innerText = "Konum: " + p.coords.latitude.toFixed(2);
                document.getElementById("locBadge").classList.add("active");
                fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&current_weather=true`)
                .then(r=>r.json()).then(d=>document.getElementById("temp").innerText=Math.round(d.current_weather.temperature)+"Â°");
            });
        }
        async function fetchNews() {
            // Haberler iÃ§in basit bir simÃ¼lasyon (GerÃ§ek API yerine)
            const news = currentLang==='tr' ? "LifeOS GÃ¼ncel Haberler: Borsa yÃ¼kseliÅŸte... Teknoloji dÃ¼nyasÄ±nda yeni geliÅŸmeler... Hava sÄ±caklÄ±klarÄ± artÄ±yor..." : "Ø§Ø®Ø¨Ø§Ø± Ø±ÙˆØ² LifeOS: Ø¨Ø§Ø²Ø§Ø± Ø³Ù‡Ø§Ù… Ø¯Ø± Ø­Ø§Ù„ Ø§ÙØ²Ø§ÛŒØ´ Ø§Ø³Øª... ØªØ­ÙˆÙ„Ø§Øª Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Ø¯Ù†ÛŒØ§ÛŒ ÙÙ†Ø§ÙˆØ±ÛŒ...";
            document.getElementById("newsText").innerText = news;
        }
    </script>
</body>
</html>
